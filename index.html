<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discharge Summary</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --bg: #f4f4f4; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .tab-nav { background: #333; display: flex; justify-content: center; sticky; top: 0; z-index: 1000; }
        .tab-nav button { background: none; border: none; padding: 15px 20px; color: white; cursor: pointer; font-size: 16px; }
        .tab-nav button.active { background: var(--primary); }
        .panel { display: none; padding: 20px; max-width: 1100px; margin: 10px auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        .section-header { background: #e9ecef; padding: 10px; margin: 15px 0 10px; font-weight: bold; border-left: 5px solid var(--primary); }
        .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; min-width: 250px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 3px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: 'Poppins'; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .med-row { display: flex; gap: 5px; background: #f9f9f9; padding: 5px; border: 1px solid #eee; margin-bottom: 5px; align-items: center; }
        .search-container { position: relative; }
        .drop-list { position: absolute; background: white; border: 1px solid #ccc; width: 100%; z-index: 100; max-height: 150px; overflow-y: auto; display: none; }
        .drop-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .drop-item:hover { background: #eee; }
        
        @media print {
            .tab-nav, .panel, #loader { display: none !important; }
            #print-view { display: block !important; padding: 20px; font-family: sans-serif; }
            .print-header { display: flex; justify-content: space-between; background: #ddd; padding: 10px; font-weight: bold; -webkit-print-color-adjust: exact; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            th, td { border: 1px solid black; padding: 8px; text-align: left; }
            th { background: #ddd !important; }
        }
        #print-view { display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Connecting to Google Sheets...</p>
    </div>

    <div class="tab-nav">
        <button id="btn-entry" class="active" onclick="showTab('entry')">New Entry</button>
        <button id="btn-list" onclick="showTab('list')">Patient Records</button>
        <button id="btn-master" onclick="showTab('master')">Settings</button>
    </div>

    <!-- ENTRY PANEL -->
    <div id="panel-entry" class="panel active">
        <h2>Patient Discharge Form</h2>
        <input type="hidden" id="entry-uid">
        
        <div class="section-header">1. Patient Details</div>
        <div class="row">
            <div class="col"><label>Name</label><input type="text" id="p-name"></div>
            <div class="col"><label>Age/Gender</label><input type="text" id="p-agegen"></div>
            <div class="col"><label>UHID</label><input type="text" id="p-uhid"></div>
        </div>

        <div class="section-header">2. Clinical Information</div>
        <div class="row">
            <div class="col search-container">
                <label>Doctor</label>
                <input type="text" id="p-doc" onfocus="showDrop('p-doc','list-doc')" placeholder="Search Doctor...">
                <div id="list-doc" class="drop-list"></div>
                <input type="hidden" id="p-doc-desig">
                <input type="hidden" id="p-doc-reg">
            </div>
            <div class="col"><label>Reason</label><input type="text" id="p-reason"></div>
            <div class="col"><label>Surgery</label><input type="text" id="p-surgery"></div>
        </div>

        <div class="section-header">3. Medication
            <button class="btn btn-primary btn-xs" style="float:right" onclick="addMedRow()">+ Add Medicine</button>
        </div>
        <div id="med-container"></div>

        <div class="section-header">4. Timings</div>
        <div class="row">
            <div class="col"><label>Admission</label><input type="date" id="p-adm-d"><input type="time" id="p-adm-t"></div>
            <div class="col"><label>Discharge</label><input type="date" id="p-dis-d"><input type="time" id="p-dis-t"></div>
        </div>

        <div style="margin-top:20px">
            <button class="btn btn-success" onclick="saveData()">SAVE & PRINT</button>
            <button class="btn btn-danger" onclick="location.reload()">RESET</button>
        </div>
    </div>

    <!-- LIST PANEL -->
    <div id="panel-list" class="panel">
        <h2>Record History</h2>
        <table id="table-history" style="width:100%; border-collapse: collapse;">
            <thead><tr style="background:#eee"><th>Date</th><th>Name</th><th>UHID</th><th>Doctor</th><th>Actions</th></tr></thead>
            <tbody id="list-body"></tbody>
        </table>
    </div>

    <!-- MASTER PANEL -->
    <div id="panel-master" class="panel">
        <h2>Manage Masters</h2>
        <div class="row">
            <div class="col">
                <h4>Add Doctor</h4>
                <input type="text" id="m-doc-n" placeholder="Name"><br>
                <input type="text" id="m-doc-d" placeholder="Designation"><br>
                <input type="text" id="m-doc-r" placeholder="Reg No"><br>
                <button class="btn btn-primary btn-xs" onclick="masterAdd('doc')">Add</button>
            </div>
            <div class="col">
                <h4>Doctors List</h4>
                <div id="m-doc-list" style="max-height:200px; overflow:auto"></div>
            </div>
        </div>
    </div>

    <!-- PRINT PREVIEW -->
    <div id="print-view">
        <div style="text-align:right">
            <img id="pr-qr" src="" style="width:80px">
        </div>
        <div class="print-header"><span>Patient: <span id="pr-name"></span></span><span>UHID: <span id="pr-uhid"></span></span></div>
        <p><b>Doctor:</b> <span id="pr-doc"></span> (<span id="pr-reg"></span>)</p>
        <p><b>Surgery:</b> <span id="pr_surg"></span></p>
        <table id="pr-meds">
            <thead><tr><th>Medicine</th><th>Dose</th><th>Freq</th><th>Duration</th></tr></thead>
            <tbody></tbody>
        </table>
        <div style="margin-top:50px; text-align:right">
            <p>___________________<br>Authorized Signatory</p>
        </div>
    </div>

    <script>
        // CONFIG
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdXlfmzNp9U9-EVPL3yQkaV43AOVAxZ25u7OA9slo5RadVpzvU6PsWv7KWDad4fYzxIA/exec";
        let DB = { doctors: [], discharges: [] };

        window.onload = () => {
            fetch(WEB_APP_URL)
                .then(res => res.json())
                .then(data => {
                    DB = data;
                    document.getElementById('loader').style.display = 'none';
                    renderAll();
                });
        };

        function showTab(t) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + t).classList.add('active');
            document.getElementById('btn-' + t).classList.add('active');
        }

        function renderAll() {
            // Render Doctor Dropdown
            const list = document.getElementById('list-doc');
            list.innerHTML = DB.doctors.map(d => `<div class="drop-item" onclick="selectDoc('${d.name}','${d.desig}','${d.reg}')">${d.name}</div>`).join('');
            
            // Render Master List
            document.getElementById('m-doc-list').innerHTML = DB.doctors.map(d => `<div>${d.name} <button onclick="deleteMaster('doc','${d.name}')">x</button></div>`).join('');

            // Render History
            document.getElementById('list-body').innerHTML = DB.discharges.map(p => `
                <tr style="border-bottom:1px solid #eee">
                    <td>${p.datedisch}</td><td>${p.name}</td><td>${p.uhid}</td><td>${p.doctor}</td>
                    <td><button onclick="editEntry('${p.uid}')">Edit</button></td>
                </tr>`).join('');
        }

        function selectDoc(n, d, r) {
            document.getElementById('p-doc').value = n;
            document.getElementById('p-doc-desig').value = d;
            document.getElementById('p-doc-reg').value = r;
            document.getElementById('list-doc').style.display = 'none';
        }

        function addMedRow(data = {}) {
            const div = document.createElement('div');
            div.className = 'med-row';
            div.innerHTML = `
                <input type="text" class="m-n" placeholder="Medicine" value="${data.name||''}" style="flex:2">
                <input type="text" class="m-d" placeholder="Dose" value="${data.dose||''}" style="width:70px">
                <input type="text" class="m-f" placeholder="Freq" value="${data.freq||''}" style="width:70px">
                <input type="text" class="m-u" placeholder="Duration" value="${data.durNum||''}" style="width:70px">
                <button onclick="this.parentElement.remove()">x</button>
            `;
            document.getElementById('med-container').appendChild(div);
        }

        function saveData() {
            const uid = document.getElementById('entry-uid').value || 'ID' + Date.now();
            const payload = {
                uid: uid,
                name: document.getElementById('p-name').value,
                uhid: document.getElementById('p-uhid').value,
                doctor: document.getElementById('p-doc').value,
                docReg: document.getElementById('p-doc-reg').value,
                surgery: document.getElementById('p-surgery').value,
                datedisch: document.getElementById('p-dis-d').value,
                medicines: []
            };
            
            document.querySelectorAll('.med-row').forEach(r => {
                payload.medicines.push({
                    name: r.querySelector('.m-n').value,
                    dose: r.querySelector('.m-d').value,
                    freq: r.querySelector('.m-f').value,
                    durNum: r.querySelector('.m-u').value
                });
            });

            // Send to Sheets
            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'saveDischarge', payload: payload })
            });

            // Print
            doPrint(payload);
        }

        function doPrint(p) {
            document.getElementById('pr-name').innerText = p.name;
            document.getElementById('pr-uhid').innerText = p.uhid;
            document.getElementById('pr-doc').innerText = p.doctor;
            document.getElementById('pr-reg').innerText = p.docReg;
            document.getElementById('pr_surg').innerText = p.surgery;
            document.getElementById('pr-qr').src = `https://api.qrserver.com/v1/create-qr-code/?data=${p.uhid}`;
            
            const tb = document.querySelector('#pr-meds tbody');
            tb.innerHTML = p.medicines.map(m => `<tr><td>${m.name}</td><td>${m.dose}</td><td>${m.freq}</td><td>${m.durNum}</td></tr>`).join('');
            
            window.print();
        }

        function showDrop(i, l) { document.getElementById(l).style.display = 'block'; }
        
        function masterAdd(type) {
            const data = { name: document.getElementById('m-doc-n').value, desig: document.getElementById('m-doc-d').value, reg: document.getElementById('m-doc-r').value };
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveDoctor', payload: data }) });
            alert('Saved. Refreshing app...');
            location.reload();
        }
    </script>
</body>
</html>
