<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discharge Summary v2.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* GLOBAL STYLES */
        :root {
            --primary-color: #0056b3;
            --bg-color: #f4f4f4;
            --border-color: #ccc;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }

        /* CUSTOM MODAL (POPUP) */
        #customModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .custom-modal {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-msg {
            font-size: 1.1em;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Poppins', sans-serif;
            min-width: 80px;
        }

        .modal-yes { background: #28a745; color: white; }
        .modal-no { background: #dc3545; color: white; }

        /* LOADING OVERLAY */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* TABS */
        .tab-nav {
            background: #333;
            overflow: hidden;
            display: flex;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .tab-nav button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            transition: 0.3s;
            font-size: 16px;
            color: white;
            font-family: 'Poppins', sans-serif;
        }

        .tab-nav button:hover {
            background-color: #555;
        }

        .tab-nav button.active {
            background-color: var(--primary-color);
        }

        /* PANELS - FULL SCREEN */
        .panel {
            display: none;
            padding: 20px;
            width: 98%;
            margin: 10px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .panel.active-panel {
            display: block;
        }

        /* FORM ELEMENTS */
        h2, h3 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        h4 {
            margin: 10px 0 5px;
            color: var(--primary-color);
        }

        .section-header {
            background: #e9ecef;
            padding: 8px;
            margin: 15px 0 10px;
            font-weight: bold;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 10px;
        }

        .col {
            flex: 1; 
            min-width: 300px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #555;
        }

        .required::after {
            content: " *";
            color: red;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        textarea { resize: vertical; }

        /* --- CUSTOM SEARCHABLE DROPDOWN --- */
        .search-dropdown-container {
            position: relative;
            width: 100%;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:hover { background-color: #f1f1f1; }
        .dropdown-item.active-item { background-color: var(--primary-color); color: white; }
        .dropdown-item:last-child { border-bottom: none; }

        /* BUTTONS */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Poppins', sans-serif;
            min-width: 100px;
            height: 42px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-view { background: #17a2b8; color: white; }
        .btn-info { background: #007bff; color: white; }

        /* EXTRA SMALL BUTTONS */
        .btn-xs {
            padding: 2px 6px;
            font-size: 11px;
            height: 28px;
            min-width: 40px;
            margin-left: 2px;
        }

        /* MEDICINE TABLE IN FORM */
        .med-row {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
            background: #f9f9f9;
            padding: 5px;
            border: 1px solid #eee;
        }
        
        .m-qty, .m-dose, .m-dur-num {
            width: 70px !important;
            flex: none !important; 
        }

        /* MASTER MANAGEMENT STYLES */
        .master-list {
            margin-top: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
            background: #fafafa;
        }

        .master-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .master-actions {
            display: flex;
            gap: 5px;
        }

        /* TABLE STYLES FOR MASTERS */
        table.master-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 5px;
        }

        table.master-table th,
        table.master-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            background: white;
        }

        table.master-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        table.master-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .staging-area {
            border: 1px dashed #999;
            padding: 10px;
            background: #fffbe6;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        #dischargeSearch {
            padding: 10px;
            border: 2px solid #ddd;
            width: 100%;
            flex: 2;
        }

        /* CUSTOM SECTION IN MASTERS */
        .custom-section-settings {
            background: #e8f4fc;
            padding: 15px;
            border: 1px solid #b6d4fe;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* ---------------- PRINT CSS ---------------- */
        #print-view {
            display: none;
        }

        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }

            .tab-nav,
            .panel,
            #loader,
            #customModalOverlay {
                display: none !important;
            }

            #print-view {
                display: block !important;
                width: 100%;
                font-family: 'Calibri', 'Arial', sans-serif;
                font-size: 11pt;
                margin-top: 0;
            }

            @page {
                size: A4;
                margin: 5mm;
            }

            .letterhead-gap {
                display: none;
            }

            .print-container {
                padding: 0 10px;
                position: relative; /* For QR positioning */
            }
            
            /* QR CODE STYLES */
            .qr-wrapper {
                position: absolute;
                top: 0;
                right: 10px;
                text-align: center;
                width: auto; /* Width auto to prevent squashing text */
                z-index: 5000;
            }

            .qr-code {
                width: 2cm;
                height: 2cm;
                display: block;
                margin: 0 auto;
            }

            .qr-text {
                font-size: 7.5pt;
                margin-top: 4px;
                font-weight: bold; /* Bold as requested */
                line-height: 1;
                display: block;
                white-space: nowrap; /* Force one line */
            }
            
            h3 {
                border-bottom: none !important;
                text-decoration: underline !important;
                margin-bottom: 10px;
                text-align: center;
                text-transform: uppercase;
                margin-top: 5px;
            }

            /* --- PATIENT / DOCTOR BOX STYLE --- */
            .info-block {
                width: 100%;
                margin-bottom: 15px;
                border: none;
                padding-top: 2.8cm; /* Increased padding to ensure QR doesn't overlap gray bar */
            }

            .header-row {
                display: flex;
                justify-content: space-between;
                font-weight: bold;
                margin-bottom: 0;
                font-size: 1.05em;
                background-color: #bfbfbf; /* Thick Gray for Header */
                padding: 8px 10px;
            }

            .info-content-row {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                background-color: #f0f0f0; /* Light Gray for Data */
                padding: 10px;
            }

            .left-info { flex: 1; }
            .right-info { 
                flex: 1; 
                text-align: right; 
                padding-right: 5px; 
            }

            /* Patient Info Internal Rows */
            .pi-row { display: flex; margin-bottom: 2px; }
            .pi-label { width: 100px; }
            .pi-sep { width: 15px; text-align: center; }
            .pi-val { flex: 1; }

            /* Standard Discharge Summary Rows (Below Gray Block) */
            .p-row { display: flex; margin-bottom: 4px; }
            .ds-label { width: 220px; font-weight: bold; flex-shrink: 0; }
            .p-sep { width: 15px; flex-shrink: 0; }
            .p-val { flex: 1; }

            /* Grid for Date details */
            .date-info-grid {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
                gap: 20px;
            }
            .date-info-col {
                flex: 1;
                display: flex;
            }

            /* --- IOL BOX STYLE (Matches Patient Box) --- */
            #pr_iol_section {
                width: 100%;
                margin: 10px 0;
                border: none;
            }

            .iol-header-bar {
                background-color: #bfbfbf !important; /* Thick Gray */
                font-weight: bold;
                padding: 8px 10px;
                border: none;
            }
            
            .iol-content-box {
                background-color: #ffffff; /* Light Gray */
                padding: 10px;
            }

            /* Partition Line Removed */
            .partition-line { display: none; }

            table.print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 11pt;
            }

            table.print-table th,
            table.print-table td {
                border: 1px solid #000;
                padding: 5px;
                text-align: center;
            }

            table.print-table td:first-child { text-align: left; }
            table.print-table th { background-color: #bfbfbf !important; }

            /* FOOTER LAYOUT */
            .print-footer {
                margin-top: 30px;
                display: flex;
                justify-content: space-between;
                align-items: flex-end; 
            }

            .footer-followup {
                border: 2px solid #000;
                padding: 10px;
                font-weight: bold;
                text-align: center;
                min-width: 200px;
            }

            .footer-sig {
                text-align: right;
                font-weight: bold;
            }
        }
    </style>
</head>

<body>

    <!-- CUSTOM MODAL -->
    <div id="customModalOverlay">
        <div class="custom-modal">
            <div id="modalMessage" class="modal-msg">Are you sure?</div>
            <div class="modal-actions">
                <button id="modalYesBtn" class="modal-btn modal-yes">Yes</button>
                <button id="modalNoBtn" class="modal-btn modal-no">No</button>
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loaderMsg" style="margin-top:20px; font-weight:bold;">Loading Data...</div>
        <div id="offlineMsg" style="margin-top:10px; font-size: 0.8em; color: red; display:none;">Running in
            External/Local Mode</div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('entryPanel')">Entry Form</button>
        <button class="tab-btn" onclick="openTab('dischargedListPanel')">Discharged List</button>
        <button class="tab-btn" onclick="openTab('mastersPanel')">Masters (Settings)</button>
    </div>

    <!-- DISCHARGED LIST PANEL -->
    <div id="dischargedListPanel" class="panel">
        <h2>Discharged Patients List</h2>
        
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; align-items: flex-end;">
            <div style="flex:2; min-width: 250px;">
                <label>Search</label>
                <input type="text" id="dischargeSearch" placeholder="ðŸ” Search by Name, UHID, Phone, Doctor..." onkeyup="renderDischargeList()" style="
    padding-top: 8px;
    padding-bottom: 8px;">
            </div>
            <div style="flex:1; min-width: 120px;">
                <label>From Date</label>
                <input type="date" id="filterDateFrom" onchange="renderDischargeList()">
            </div>
            <div style="flex:1; min-width: 120px;">
                <label>To Date</label>
                <input type="date" id="filterDateTo" onchange="renderDischargeList()">
            </div>
            <button class="btn btn-success" style="height: 41px;" onclick="exportToCSV()">Export CSV</button>
        </div>
        
        <div id="dischargeTableContainer">
            <table class="master-table">
                <thead>
                    <tr>
                        <th width="85px">Date</th>
                        <th>Patient Name</th>
                        <th>Age/Gender</th>
                        <th>UHID</th>
                        <th>Doctor</th>
                        <th>IOL Name</th>
                        <th>Power</th>
                        <th>Serial No</th>
                        <th width="140px">Actions</th>
                    </tr>
                </thead>
                <tbody id="dischargeListBody">
                    <tr><td colspan="9" style="text-align:center;">No records found yet.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="mastersPanel" class="panel">
        <h2>Manage Master Data</h2>
        
        <!-- CUSTOM PRINT LINES SETTINGS -->
        <div class="custom-section-settings">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4>Manage Custom Print Lines</h4>
                <div style="background: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc;">
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 0; cursor: pointer;">
                        <input type="checkbox" id="mShowQR" onchange="toggleQRSetting()" style="width: auto;"> 
                        <span>Enable QR Code on Printout</span>
                    </label>
                </div>
            </div>
            <p style="font-size:0.9em; color:#666;">Lines appear in the printout if enabled.</p>
            
            <!-- ALIGNMENT FIX: Wrapped in flex row for straight line -->
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap;">
                <div style="flex: 1;">
                    <label>Heading</label>
                    <input type="text" id="mCustHeading" placeholder="e.g. Special Note">
                </div>
                <div style="flex: 2;height: 62px;">
                    <label>Narration (Text)</label>
                    <textarea id="mCustText" rows="1" placeholder="Enter the text content..." style="height: 38px; min-height: 38px;"></textarea>
                </div>
                <div style="flex-shrink: 0;">
                    <button class="btn btn-primary" style="height: 38px;" onclick="addCustomLine()">Add Line</button>
                </div>
            </div>
            
            <div id="customLinesList" class="master-list" style="margin-top:10px; max-height:250px;">
                 <!-- Table rendered via JS -->
            </div>
        </div>

        <div class="row">
            <div class="col">
                <h4>Doctors</h4>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="mDocName" placeholder="Doctor Name" style="flex:2">
                    <input type="text" id="mDocDesig" placeholder="Designation" style="flex:2">
                    <input type="text" id="mDocReg" placeholder="Reg Number" style="flex:1">
                    <button class="btn btn-success btn-xs" onclick="addMasterDoctor()" style="
    height: 37px;
">Add</button>
                </div>
                <div id="docList" class="master-list"></div>
            </div>

            <div class="col">
                <h4>Clinical & IOL Dropdowns</h4>
                <select id="mTemplateType" onchange="renderMasters()">
                    <option value="reason">Reason for Admission</option>
                    <option value="surgery">Surgery Performed</option>
                    <option value="investigation">Investigation</option>
                    <option value="anaesthesia">Anaesthesia</option>
                    <option value="diagnosis">Diagnosis</option>
                    <option value="iol">IOL Names</option>
                </select>
                <div style="display: flex; gap: 5px; margin-top:5px;">
                    <input type="text" id="mTemplateValue" placeholder="Enter value...">
                    <button class="btn btn-success btn-xs" onclick="addClinicalItem()" style="
    height: 37px;">Add</button>
                </div>
                <div id="clinicalList" class="master-list"></div>
            </div>
        </div>

        <hr>

        <h3>Clinical Templates</h3>
        <div class="staging-area">
            <div class="row">
                <div class="col">
                    <label>Template Name</label>
                    <input type="text" id="mClinTitle" placeholder="e.g. Cataract Routine">
                </div>
                <div class="col">
                    <label>Reason of Admission</label>
                    <div class="search-dropdown-container">
                        <input type="text" id="mClinReason" placeholder="Search Reason..." autocomplete="off">
                        <div id="listMClinReason" class="dropdown-list"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Surgery Performed</label>
                    <div class="search-dropdown-container">
                        <input type="text" id="mClinSurgery" placeholder="Search Surgery..." autocomplete="off">
                        <div id="listMClinSurgery" class="dropdown-list"></div>
                    </div>
                </div>
                <div class="col">
                    <label>Investigation</label>
                    <div class="search-dropdown-container">
                        <input type="text" id="mClinInv" placeholder="Search Investigation..." autocomplete="off">
                        <div id="listMClinInv" class="dropdown-list"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-success" style="width:200px; margin-top:10px;" onclick="saveClinicalGroup()">Save Template</button>
        </div>
        <div id="clinGroupList" class="master-list" style="max-height: 200px;"></div>

        <hr>

        <h3>Medicine Templates</h3>
        <div class="staging-area">
            <label>1. Template Name</label>
            <input type="text" id="mGroupTitle" placeholder="e.g. Cataract Medication" style="width: 50%;">

            <label style="margin-top:10px;">2. Add Medicines to Template</label>
            <div style="display:flex; gap:5px; font-size: 0.8em; font-weight: bold; color: #555; margin-bottom: 2px;">
                <div style="flex:3">Medicine Name</div>
                <div style="width:90px">Site</div>
                <div style="width:70px">Qty</div>
                <div style="width:70px">Dose</div>
                <div style="flex:1">Freq</div>
                <div style="flex:2">Duration</div>
                <div style="width:40px">Action</div>
            </div>
            <div style="display:flex; gap:5px; align-items: center;">
                <input type="text" id="stgName" placeholder="Name" style="flex:3">
                <select id="stgSite" style="width:90px">
                    <option value="">Site</option>
                    <option value="Right Eye">RE</option>
                    <option value="Left Eye">LE</option>
                    <option value="Both Eyes">BE</option>
                </select>
                <input type="text" id="stgQty" placeholder="Qty" class="m-qty">
                <input type="text" id="stgDose" placeholder="Dose" class="m-dose">
                <!-- UPDATED FREQ TO SEARCHABLE DROPDOWN -->
                <div class="search-dropdown-container" style="flex:1;">
                    <input type="text" id="stgFreq" placeholder="Freq" autocomplete="off">
                    <div id="listStgFreq" class="dropdown-list"></div>
                </div>
                
                <div style="flex:2; display:flex; gap:2px;">
                     <input type="number" id="stgDurNum" placeholder="#" class="m-dur-num">
                     <select id="stgDurUnit" style="flex:1;">
                        <option value="Days">Days</option>
                        <option value="Weeks">Weeks</option>
                        <option value="Months">Months</option>
                        <option value="Years">Years</option>
                        <option value="Life Time">Life Time</option>
                        <option value="To be continued">To be continued</option>
                     </select>
                </div>

                <button class="btn btn-secondary btn-xs" onclick="stageMedicine()" style="
    height: 40px;
    width: 42px;">Add</button>
            </div>

            <div style="margin-top:10px; font-weight:bold;">Staged Medicines:</div>
            <div id="stagingTableContainer" style="margin-top: 5px;"></div>

            <button class="btn btn-success" style="width:200px; margin-top:10px;" onclick="saveMedicineGroup()">Save Template</button>
        </div>

        <label>Saved Medicine Templates</label>
        <div id="medGroupList" class="master-list" style="height: auto; max-height: 400px;"></div>
    </div>

    <div id="entryPanel" class="panel active-panel">
        <h2>Discharge Summary Entry</h2>
        <!-- UNIQUE ID HIDDEN FIELD -->
        <input type="hidden" id="entryUID">

        <div class="section-header">Patient & Doctor Information</div>
        <div class="row">
            <div class="col">
                <label class="required">Patient Name</label>
                <input type="text" id="pName">
            </div>
            <div class="col">
                <label class="required">Age & Gender</label>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="pAge" style="flex: 1;">
                    <div class="search-dropdown-container" style="flex: 1;">
                        <input type="text" id="pGender" placeholder="Gender" autocomplete="off">
                        <div id="listGender" class="dropdown-list"></div>
                    </div>
                </div>
            </div>
            <div class="col">
                <label>UHID</label>
                <input type="text" id="pUHID">
            </div>
            <div class="col">
                <label>Phone Number</label>
                <input type="text" id="pPhone" maxlength="10" placeholder="Mobile Number"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="required">Address</label>
                <textarea id="pAddress" rows="1"></textarea>
            </div>
            <div class="col">
                <label>Select Doctor</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selDoc" placeholder="Type to search Doctor..." autocomplete="off">
                    <div id="listDoc" class="dropdown-list"></div>
                </div>
                <input type="hidden" id="hDocName">
                <input type="hidden" id="hDocDesig">
                <input type="hidden" id="hDocReg">
            </div>
        </div>

        <div class="section-header">Clinical Information</div>

        <div style="margin-bottom: 15px; background: #e2e6ea; padding: 10px; border-radius: 4px;">
            <label>Load Clinical Template</label>
            <select id="clinicalTemplateSelect" onchange="loadClinicalTemplate()" style="width: 100%;">
                <option value="">-- Select Template --</option>
            </select>
        </div>

        <div class="row">
            <div class="col">
                <label class="required">Reason of Admission</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selReason" placeholder="Type or Select..." autocomplete="off">
                    <div id="listReason" class="dropdown-list"></div>
                </div>
            </div>
            <div class="col">
                <label class="required">Surgery Performed</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selSurgery" placeholder="Type or Select..." autocomplete="off">
                    <div id="listSurgery" class="dropdown-list"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="required">Investigations</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selInv" placeholder="Type or Select..." autocomplete="off">
                    <div id="listInv" class="dropdown-list"></div>
                </div>
            </div>
            <div class="col">
                <label class="required">Anaesthesia Given</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selAnaesthesia" placeholder="Type or Select..." autocomplete="off">
                    <div id="listAnaesthesia" class="dropdown-list"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Final Diagnosis - Right Eye</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selDiagRight" placeholder="Select Right Eye Diagnosis..." autocomplete="off">
                    <div id="listDiagRight" class="dropdown-list"></div>
                </div>
            </div>
            <div class="col">
                <label>Final Diagnosis - Left Eye</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selDiagLeft" placeholder="Select Left Eye Diagnosis..." autocomplete="off">
                    <div id="listDiagLeft" class="dropdown-list"></div>
                </div>
            </div>
        </div>

        <div class="section-header">IOL Details</div>
        <div class="row">
            <div class="col">
                <label>IOL Name</label>
                <div class="search-dropdown-container">
                    <input type="text" id="selIOL" placeholder="Type or Select..." autocomplete="off">
                    <div id="listIOL" class="dropdown-list"></div>
                </div>
            </div>
            <div class="col">
                <label>Serial Number</label>
                <input type="text" id="iolSerial" placeholder="Serial No.">
            </div>
            <div class="col">
                <label>IOL Power</label>
                <input type="text" id="iolPower" placeholder="Power">
            </div>
            <div class="col"><small style="color:#666; line-height: 2.5;"></small></div>
        </div>

        <div class="section-header">
            <span>Medicines</span>
            <button class="btn btn-warning btn-xs" onclick="clearMedicinesOnly()" style="
    height: 36px;">Clear Medication</button>
        </div>
        <div style="margin-bottom: 10px; background: #e2e6ea; padding: 10px; border-radius: 4px;">
            <label>Load Medicine Template</label>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <select id="medTemplateSelect" onchange="loadMedTemplate()" style="flex: 1; min-width: 250px;">
                    <option value="">-- Select Template --</option>
                </select>
                <button class="btn btn-secondary btn-xs" onclick="addEmptyMedRow()" style="
    height: 36px;">+ Single Row</button>
            </div>
        </div>
        <div style="display:flex; gap:5px; margin-bottom: 5px; font-weight: bold; padding: 0 5px;">
            <div style="flex:3">Medicine Name</div>
            <div style="width:85px">Site</div>
            <div style="width:70px">Qty</div>
            <div style="width:70px">Dose</div>
            <div style="flex:2">Freq</div>
            <div style="flex:3">Dur (No. & Unit)</div>
            <div style="width:40px"></div>
        </div>
        <div id="medicineRowsContainer"></div>

        <div class="section-header">Admission , Surgery & Discharge Timings</div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px;">
                <label>Admission Date & Time</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="dateAdm" style="flex: 2;">
                    <input type="time" id="timeAdm" style="flex: 1;">
                </div>
            </div>
            <div style="flex: 1; min-width: 280px;">
                <label>Surgery Date & Time</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="dateSurg" style="flex: 2;">
                    <input type="time" id="timeSurg" style="flex: 1;">
                </div>
            </div>
            <div style="flex: 1; min-width: 280px;">
                <label>Discharge Date & Time</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="dateDisch" onchange="calcFollowUp()" style="flex: 2;">
                    <input type="time" id="timeDisch" style="flex: 1;">
                </div>
            </div>
        </div>

        <div class="section-header">Post OP Follow Up</div>
        <div class="row">
            <div class="col">
                <label>Post OP Follow Up Date & Time</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="followUpDate" style="flex: 2;">
                    <input type="time" id="followUpTime" value="09:00" style="flex: 1;">
                </div>
            </div>
        </div>

        <div id="actionButtonsContainer" style="margin-top:20px; display:flex; gap:10px; width: 100%;">
            <!-- Buttons are rendered via JS -->
        </div>
    </div>

    <!-- PRINT VIEW -->
    <div id="print-view">
        <div class="letterhead-gap"></div>

        <div class="print-container">
            <!-- QR CODE TOP RIGHT -->
            <div id="pr_qr_container" class="qr-wrapper">
                <img src="base64codepastehere" class="qr-code" alt="QR">
                <span class="qr-text">scan QR code for post op instructions</span>
            </div>

            <!-- PATIENT DETAILS BLOCK -->
            <div class="info-block">
                <div class="header-row">
                    <span>Patient Details</span>
                    <span>Doctor Details</span>
                </div>
                
                <div class="info-content-row">
                    <!-- Left Side: Patient Info -->
                    <div class="left-info">
                        <div class="pi-row">
                            <div class="pi-label">Name</div>
                            <div class="pi-sep">:</div>
                            <div class="pi-val" id="pr_name"></div>
                        </div>
                        <div class="pi-row">
                            <div class="pi-label">Age/Gender</div>
                            <div class="pi-sep">:</div>
                            <div class="pi-val" id="pr_agegen"></div>
                        </div>
                        <div class="pi-row">
                            <div class="pi-label">UHID</div>
                            <div class="pi-sep">:</div>
                            <div class="pi-val" id="pr_uhid"></div>
                        </div>
                        <div class="pi-row">
                            <div class="pi-label">Phone</div>
                            <div class="pi-sep">:</div>
                            <div class="pi-val" id="pr_phone"></div>
                        </div>
                        <div class="pi-row">
                            <div class="pi-label">Address</div>
                            <div class="pi-sep">:</div>
                            <div class="pi-val" id="pr_address"></div>
                        </div>
                    </div>

                    <!-- Right Side: Doctor Info -->
                    <div class="right-info">
                        <div style="font-weight: bold; margin-bottom: 5px;" id="pr_dname"></div>
                        <div id="pr_ddesig"></div>
                    </div>
                </div>
            </div>

            <div class="partition-line"></div>

            <h3>Discharge Summary</h3>

            <div class="date-info-grid">
                <div class="date-info-col">
                    <span class="ds-label">Date & Time of Admission</span><span class="p-sep">:</span><span class="p-val" id="pr_adm"></span>
                </div>
                <div class="date-info-col">
                    <span class="ds-label">Date & Time of Surgery</span><span class="p-sep">:</span><span class="p-val" id="pr_surg"></span>
                </div>
            </div>

            <div class="date-info-grid">
                <div class="date-info-col">
                    <span class="ds-label">Date & Time of Discharge</span><span class="p-sep">:</span><span class="p-val" id="pr_disch"></span>
                </div>
                <div class="date-info-col">
                    <span class="ds-label">Surgeon</span><span class="p-sep">:</span><span class="p-val" id="pr_surgeon"></span>
                </div>
            </div>

            <br>

            <div class="p-row"><span class="ds-label">Reason of Admission</span><span class="p-sep">:</span><span
                    class="p-val" id="pr_reason"></span></div>

            <div class="p-row">
                <span class="ds-label">Final Diagnosis</span><span class="p-sep">:</span>
                <span class="p-val" id="pr_diagnosis_combined" style="display:block;"></span>
            </div>

            <div class="p-row"><span class="ds-label">Surgery Performed</span><span class="p-sep">:</span><span
                    class="p-val" id="pr_surgery"></span></div>
            <div class="p-row"><span class="ds-label">Investigations</span><span class="p-sep">:</span><span
                    class="p-val" id="pr_inv"></span></div>
            
            <div id="pr_custom_section_container">
                 <!-- Injected via JS -->
            </div>

            <div class="p-row"><span class="ds-label">Anaesthesia</span><span class="p-sep">:</span><span class="p-val"
                    id="pr_ana"></span></div>
            <br>

            <div id="pr_iol_section">
                <div class="iol-header-bar"><span>IOL Details</span></div>
                <div class="iol-content-box">
                    <div class="p-row"><span class="ds-label" style="width:140px;">IOL Name</span><span class="p-sep">:</span><span class="p-val"
                            id="pr_iolname"></span></div>
                    <div class="p-row"><span class="ds-label" style="width:140px;">Serial Number</span><span class="p-sep">:</span><span
                            class="p-val" id="pr_iolserial"></span></div>
                    <div class="p-row"><span class="ds-label" style="width:140px;">Power</span><span class="p-sep">:</span><span class="p-val"
                            id="pr_iolpower"></span></div>
                </div>
            </div>

            <table class="print-table">
                <thead>
                    <tr>
                        <th width="35%">Medicine Name</th>
                        <th width="10%">Qty</th>
                        <th width="10%">Dosage</th>
                        <th width="20%">Frequency</th>
                        <th width="25%">Duration</th>
                    </tr>
                </thead>
                <tbody id="pr_medBody"></tbody>
            </table>

            <div class="print-footer">
                <div class="footer-followup">
                    1st Follow Up Date:<br>
                    <span id="pr_followup" style="font-size:0.9em;"></span>
                </div>
                <div class="footer-sig">
                    <div id="pr_sigName"></div>
                    <div id="pr_sigReg" style="font-weight: normal; font-size: 0.9em;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // *** PASTE YOUR WEB APP URL BELOW ***
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdXlfmzNp9U9-EVPL3yQkaV43AOVAxZ25u7OA9slo5RadVpzvU6PsWv7KWDad4fYzxIA/exec";
        // ==========================================

        let store = {
            doctors: [],
            clinics: { 
                reason: [], 
                surgery: [], 
                investigation: [], 
                iol: [], 
                anaesthesia: ['Topical Anaesthesia', 'Local Anaesthesia', 'General Anaesthesia'],
                diagnosis: [] 
            },
            medGroups: [],
            clinGroups: [],
            discharges: [],
            customLines: [],
            config: { showQR: true }
        };
        let tempMedStage = [];
        
        // Define frequency options
        const freqOptions = [
            "Once a day", "Twice a day", "Thrice a day", "Four times a day",
            "Five times a day", "Six times a day", "Seven times a day",
            "Eight times a day", "When needed", "Stat", "Every 1 hour",
            "Every 2 hours", "Every 4 hours", "Every 6 hours", "Every 12 hours"
        ];
        
        function generateUUID() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        window.onload = function () {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(populateStore).getBackendData();
            } else {
                console.warn("Environment: External. Fetching from Web App.");
                document.getElementById('offlineMsg').style.display = 'block';

                if (WEB_APP_URL) {
                    document.getElementById('loaderMsg').innerText = "Syncing with Web App...";
                    fetch(WEB_APP_URL)
                        .then(response => response.json())
                        .then(data => populateStore(data))
                        .catch(e => {
                            console.error("Sync failed.", e);
                            loadMockData();
                        });
                } else {
                    loadMockData();
                }
            }

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.search-dropdown-container')) {
                    document.querySelectorAll('.dropdown-list').forEach(l => l.style.display = 'none');
                }
            });
        };

        function showConfirm(message, callback) {
            const overlay = document.getElementById('customModalOverlay');
            const msgDiv = document.getElementById('modalMessage');
            const yesBtn = document.getElementById('modalYesBtn');
            const noBtn = document.getElementById('modalNoBtn');

            msgDiv.textContent = message;
            overlay.style.display = 'flex';

            yesBtn.onclick = function() {
                overlay.style.display = 'none';
                callback(true);
            };

            noBtn.onclick = function() {
                overlay.style.display = 'none';
                callback(false);
            };
        }

        function loadMockData() {
            populateStore({
                doctors: [], reasons: [], surgeries: [], investigations: [], iols: [], medGroups: [], clinGroups: [], customLines: [], diagnosis: [], config: { showQR: true }
            });
        }

        function populateStore(data) {
            store = {
                doctors: data.doctors || [],
                clinics: {
                    reason: data.reasons || [],
                    surgery: data.surgeries || [],
                    investigation: data.investigations || [],
                    iol: data.iols || [],
                    anaesthesia: data.anaesthesia || ['Topical Anesthesia', 'Local Anesthesia', 'General Anesthesia'],
                    diagnosis: data.diagnosis || []
                },
                medGroups: data.medGroups || [],
                clinGroups: data.clinGroups || [],
                discharges: data.discharges || [],
                customLines: data.customLines || [],
                config: data.config || { showQR: true }
            };
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mShowQR').checked = store.config.showQR;
            renderMasters();
            populateEntryDropdowns();
            resetForm();
            renderDischargeList();
        }

        function toggleQRSetting() {
            store.config.showQR = document.getElementById('mShowQR').checked;
            if (typeof google !== 'undefined' && google.script) google.script.run.saveConfigToSheet(store.config);
        }

        function setupSearchableDropdown(inputId, listId, data, onSelectCallback = null) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            let currentFocus = -1;

            const buildList = (filter = "") => {
                list.innerHTML = "";
                const filtered = data.filter(item => item.toLowerCase().includes(filter.toLowerCase()));
                if (filtered.length === 0) { list.style.display = 'none'; return; }

                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = item;
                    div.onclick = () => { selectItem(item); };
                    list.appendChild(div);
                });
                list.style.display = 'block';
            };

            const selectItem = (val) => {
                input.value = val;
                list.style.display = 'none';
                currentFocus = -1;
                if (onSelectCallback) onSelectCallback(val);
            };

            const addActive = (x) => {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("active-item");
                x[currentFocus].scrollIntoView({ block: 'nearest' });
            };

            const removeActive = (x) => {
                for (let i = 0; i < x.length; i++) { x[i].classList.remove("active-item"); }
            };

            input.oninput = () => { currentFocus = -1; buildList(input.value); };
            input.onfocus = () => { currentFocus = -1; buildList(input.value); };
            
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    list.style.display = 'none';
                }, 200);
            });

            input.onkeydown = function (e) {
                let x = list.getElementsByClassName("dropdown-item");
                if (e.keyCode == 40) { currentFocus++; addActive(x); }
                else if (e.keyCode == 38) { currentFocus--; addActive(x); }
                else if (e.keyCode == 13) {
                    if (list.style.display === 'block') {
                        e.preventDefault();
                        if (currentFocus > -1) { if (x) x[currentFocus].click(); }
                        else if (x.length === 1) { x[0].click(); }
                    }
                }
                else if (e.keyCode == 27) { list.style.display = 'none'; }
            };
        }

        function populateEntryDropdowns() {
            const doctorNames = store.doctors.map(d => d.name);
            setupSearchableDropdown('selDoc', 'listDoc', doctorNames, (selectedName) => {
                const docObj = store.doctors.find(d => d.name === selectedName);
                if (docObj) {
                    document.getElementById('hDocName').value = docObj.name;
                    document.getElementById('hDocDesig').value = docObj.desig;
                    document.getElementById('hDocReg').value = docObj.reg;
                }
            });

            const mSel = document.getElementById('medTemplateSelect');
            mSel.innerHTML = '<option value="">-- Select Template --</option>';
            store.medGroups.forEach((g, i) => mSel.innerHTML += `<option value="${i}">${g.title}</option>`);

            const cSel = document.getElementById('clinicalTemplateSelect');
            cSel.innerHTML = '<option value="">-- Select Template --</option>';
            store.clinGroups.forEach((g, i) => cSel.innerHTML += `<option value="${i}">${g.title}</option>`);

            setupSearchableDropdown('selReason', 'listReason', store.clinics.reason);
            setupSearchableDropdown('selSurgery', 'listSurgery', store.clinics.surgery);
            setupSearchableDropdown('selInv', 'listInv', store.clinics.investigation);
            setupSearchableDropdown('selIOL', 'listIOL', store.clinics.iol);
            setupSearchableDropdown('selAnaesthesia', 'listAnaesthesia', store.clinics.anaesthesia);
            setupSearchableDropdown('selDiagRight', 'listDiagRight', store.clinics.diagnosis);
            setupSearchableDropdown('selDiagLeft', 'listDiagLeft', store.clinics.diagnosis);
            setupSearchableDropdown('pGender', 'listGender', ['Male', 'Female', 'Other']);
            setupSearchableDropdown('mClinReason', 'listMClinReason', store.clinics.reason);
            setupSearchableDropdown('mClinSurgery', 'listMClinSurgery', store.clinics.surgery);
            setupSearchableDropdown('mClinInv', 'listMClinInv', store.clinics.investigation);
            
            // Setup Dropdown for Medicine Staging Frequency
            setupSearchableDropdown('stgFreq', 'listStgFreq', freqOptions);
        }

        function renderMasters() {
            const custContainer = document.getElementById('customLinesList');
            if(store.customLines.length === 0) {
                custContainer.innerHTML = '<i>No lines added.</i>';
            } else {
                let tableHtml = `<table class="master-table">
                    <thead><tr><th>Heading</th><th>Narration (Text)</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>`;
                store.customLines.forEach((l, index) => {
                    const statusBtn = l.active 
                        ? `<button class="btn btn-success btn-xs" onclick="toggleCustomLine(${index})">Enabled</button>`
                        : `<button class="btn btn-secondary btn-xs" onclick="toggleCustomLine(${index})">Disabled</button>`;
                    tableHtml += `<tr>
                        <td><b>${l.heading}</b></td>
                        <td>${l.text}</td>
                        <td>${statusBtn}</td>
                        <td>
                             <button class="btn btn-warning btn-xs" onclick="editCustomLine(${index})">âœï¸</button>
                             <button class="btn btn-danger btn-xs" onclick="deleteCustomLine(${index})">ðŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                custContainer.innerHTML = tableHtml;
            }

            let docHtml = '<table class="master-table"><thead><tr><th width="35%">Name</th><th width="30%">Designation</th><th width="20%">Reg No.</th><th>Actions</th></tr></thead><tbody>';
            if (store.doctors.length === 0) docHtml += '<tr><td colspan="4" style="text-align:center">No doctors found</td></tr>';
            else {
                store.doctors.forEach(d => {
                    docHtml += `<tr><td>${d.name}</td><td>${d.desig}</td><td>${d.reg}</td><td>
                        <button class="btn btn-warning btn-xs" onclick="editDoc('${d.name}')">âœï¸</button>
                        <button class="btn btn-danger btn-xs" onclick="deleteItem('doc', '${d.name}')">ðŸ—‘ï¸</button>
                    </td></tr>`;
                });
            }
            docHtml += '</tbody></table>';
            document.getElementById('docList').innerHTML = docHtml;

            const type = document.getElementById('mTemplateType').value;
            const list = store.clinics[type] || [];
            document.getElementById('clinicalList').innerHTML = list.map(val => `
                <div class="master-item">
                    <span>${val}</span>
                    <div class="master-actions">
                        <button class="btn btn-warning btn-xs" onclick="editClinicalItem('${type}', '${val}')">âœï¸</button>
                        <button class="btn btn-danger btn-xs" onclick="deleteItem('${type}', '${val}')">ðŸ—‘ï¸</button>
                    </div>
                </div>`).join('');

            let clinHtml = '<table class="master-table"><thead><tr><th width="20%">Name</th><th>Reason</th><th>Surgery</th><th>Inv</th><th>Actions</th></tr></thead><tbody>';
            store.clinGroups.forEach(g => {
                clinHtml += `<tr><td><b>${g.title}</b></td><td>${g.reason}</td><td>${g.surgery}</td><td>${g.inv}</td><td>
                    <button class="btn btn-warning btn-xs" onclick="editClinGroup('${g.title}')">âœï¸</button>
                    <button class="btn btn-danger btn-xs" onclick="deleteItem('clinGroup', '${g.title}')">ðŸ—‘ï¸</button>
                </td></tr>`;
            });
            clinHtml += '</tbody></table>';
            document.getElementById('clinGroupList').innerHTML = clinHtml;

            let medHtml = '<table class="master-table"><thead><tr><th width="20%">Template Name</th><th>Medicines Details</th><th width="10%">Actions</th></tr></thead><tbody>';
            store.medGroups.forEach(g => {
                let innerTable = '<table style="width:100%; border-collapse:collapse; font-size:0.8em; background:#fff;">';
                innerTable += '<tr style="background:#eee; font-weight:bold;"><td>Name</td><td>Site</td><td>Qty</td><td>Dose</td><td>Freq</td><td>Dur</td></tr>';
                g.meds.forEach(m => {
                    let durDisplay = m.durUnit;
                    if(m.durUnit !== "Life Time" && m.durUnit !== "To be continued") {
                         let unitLabel = (m.durNum == 1) ? m.durUnit.slice(0, -1) : m.durUnit;
                         durDisplay = `${m.durNum} ${unitLabel}`;
                    }
                    innerTable += `<tr>
                        <td style="border:1px solid #ddd; padding:2px;">${m.name}</td>
                        <td style="border:1px solid #ddd; padding:2px;">${m.site}</td>
                        <td style="border:1px solid #ddd; padding:2px;">${m.qty}</td>
                        <td style="border:1px solid #ddd; padding:2px;">${m.dose}</td>
                        <td style="border:1px solid #ddd; padding:2px;">${m.freq}</td>
                        <td style="border:1px solid #ddd; padding:2px;">${durDisplay}</td>
                    </tr>`;
                });
                innerTable += '</table>';
                medHtml += `<tr>
                    <td style="vertical-align:top"><b>${g.title}</b></td>
                    <td style="padding:0;">${innerTable}</td>
                    <td style="vertical-align:top">
                        <div class="master-actions">
                            <button class="btn btn-warning btn-xs" onclick="editMedGroup('${g.title}')">âœï¸</button>
                            <button class="btn btn-danger btn-xs" onclick="deleteItem('medGroup', '${g.title}')">ðŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>`;
            });
            medHtml += '</tbody></table>';
            document.getElementById('medGroupList').innerHTML = medHtml;
        }

        function addCustomLine() {
            const h = document.getElementById('mCustHeading').value;
            const t = document.getElementById('mCustText').value;
            if(!h) return alert("Heading required");
            store.customLines.push({id: generateUUID(), heading: h, text: t, active: true});
            document.getElementById('mCustHeading').value = '';
            document.getElementById('mCustText').value = '';
            if (typeof google !== 'undefined' && google.script) google.script.run.saveCustomLinesToSheet(store.customLines);
            renderMasters();
        }

        function toggleCustomLine(idx) {
            store.customLines[idx].active = !store.customLines[idx].active;
            if (typeof google !== 'undefined' && google.script) google.script.run.saveCustomLinesToSheet(store.customLines);
            renderMasters();
        }

        function deleteCustomLine(idx) {
            showConfirm("Delete this custom line?", function(res){
                if(res) {
                    store.customLines.splice(idx, 1);
                    if (typeof google !== 'undefined' && google.script) google.script.run.saveCustomLinesToSheet(store.customLines);
                    renderMasters();
                }
            });
        }

        function editCustomLine(idx) {
            const l = store.customLines[idx];
            document.getElementById('mCustHeading').value = l.heading;
            document.getElementById('mCustText').value = l.text;
            store.customLines.splice(idx, 1);
            renderMasters();
        }

        function deleteItem(type, id) {
            showConfirm("Are you sure you want to delete this item?", function(res) {
                if(res) {
                    if (type === 'doc') store.doctors = store.doctors.filter(d => d.name !== id);
                    else if (type === 'medGroup') store.medGroups = store.medGroups.filter(g => g.title !== id);
                    else if (type === 'clinGroup') store.clinGroups = store.clinGroups.filter(g => g.title !== id);
                    else store.clinics[type] = store.clinics[type].filter(v => v !== id);
                    if (typeof google !== 'undefined' && google.script) google.script.run.deleteFromSheet(type, id);
                    renderMasters(); populateEntryDropdowns();
                }
            });
        }

        function editDoc(name) {
            const d = store.doctors.find(x => x.name === name);
            if (d) {
                document.getElementById('mDocName').value = d.name;
                document.getElementById('mDocDesig').value = d.desig;
                document.getElementById('mDocReg').value = d.reg;
                store.doctors = store.doctors.filter(d => d.name !== name);
                renderMasters();
            }
        }

        function editClinicalItem(type, val) {
            document.getElementById('mTemplateValue').value = val;
            store.clinics[type] = store.clinics[type].filter(v => v !== val);
            renderMasters();
        }

        function editMedGroup(title) {
            const g = store.medGroups.find(x => x.title === title);
            if (g) {
                document.getElementById('mGroupTitle').value = g.title;
                tempMedStage = [...g.meds];
                renderStaging();
                store.medGroups = store.medGroups.filter(g => g.title !== title);
                renderMasters();
            }
        }
        
        function editClinGroup(title) {
            const g = store.clinGroups.find(x => x.title === title);
            if(g) {
                document.getElementById('mClinTitle').value = g.title;
                document.getElementById('mClinReason').value = g.reason;
                document.getElementById('mClinSurgery').value = g.surgery;
                document.getElementById('mClinInv').value = g.inv;
                store.clinGroups = store.clinGroups.filter(g => g.title !== title);
                renderMasters();
            }
        }

        function addMasterDoctor() {
            const d = { name: document.getElementById('mDocName').value, desig: document.getElementById('mDocDesig').value, reg: document.getElementById('mDocReg').value };
            if (d.name) {
                store.doctors.push(d);
                if (typeof google !== 'undefined' && google.script) google.script.run.saveDoctorToSheet(d);
                document.getElementById('mDocName').value = ''; document.getElementById('mDocDesig').value = ''; document.getElementById('mDocReg').value = '';
                renderMasters(); populateEntryDropdowns();
            }
        }

        function addClinicalItem() {
            const type = document.getElementById('mTemplateType').value;
            const val = document.getElementById('mTemplateValue').value;
            if (val) {
                store.clinics[type].push(val);
                if (typeof google !== 'undefined' && google.script) google.script.run.saveClinicalToSheet(type, val);
                document.getElementById('mTemplateValue').value = '';
                renderMasters(); populateEntryDropdowns();
            }
        }

        function saveClinicalGroup() {
            const title = document.getElementById('mClinTitle').value;
            if (!title) return alert("Template Name required");
            const group = { title: title, reason: document.getElementById('mClinReason').value, surgery: document.getElementById('mClinSurgery').value, inv: document.getElementById('mClinInv').value };
            store.clinGroups.push(group);
            if (typeof google !== 'undefined' && google.script) google.script.run.saveClinTemplateToSheet(group);
            document.getElementById('mClinTitle').value = ''; document.getElementById('mClinReason').value = ''; document.getElementById('mClinSurgery').value = ''; document.getElementById('mClinInv').value = '';
            renderMasters(); populateEntryDropdowns();
        }

        function loadClinicalTemplate() {
            const idx = document.getElementById('clinicalTemplateSelect').value;
            if (idx === "") return;
            const group = store.clinGroups[idx];
            if (group) {
                document.getElementById('selReason').value = group.reason;
                document.getElementById('selSurgery').value = group.surgery;
                document.getElementById('selInv').value = group.inv;
            }
        }

        function stageMedicine() {
            const name = document.getElementById('stgName').value;
            if (!name) return;
            const num = document.getElementById('stgDurNum').value;
            const unit = document.getElementById('stgDurUnit').value;
            tempMedStage.push({
                name: name, 
                site: document.getElementById('stgSite').value || "",
                qty: document.getElementById('stgQty').value || "-", 
                dose: document.getElementById('stgDose').value || "-",
                freq: document.getElementById('stgFreq').value || "-", 
                durNum: num,
                durUnit: unit
            });
            ['stgName', 'stgSite', 'stgQty', 'stgDose', 'stgFreq', 'stgDurNum'].forEach(id => document.getElementById(id).value = '');
            renderStaging();
        }

        function renderStaging() {
            const container = document.getElementById('stagingTableContainer');
            if (tempMedStage.length === 0) { container.innerHTML = '<i>No meds staged.</i>'; return; }
            let html = '<table class="master-table" style="font-size:0.85em">';
            html += '<thead><tr><th>Name</th><th>Site</th><th>Qty</th><th>Dose</th><th>Freq</th><th>Dur</th><th>Action</th></tr></thead><tbody>';
            tempMedStage.forEach((m, i) => {
                let durDisplay = m.durUnit;
                if(m.durUnit !== "Life Time" && m.durUnit !== "To be continued") {
                     let unitLabel = (m.durNum == 1) ? m.durUnit.slice(0, -1) : m.durUnit;
                     durDisplay = `${m.durNum} ${unitLabel}`;
                }
                html += `<tr><td>${m.name}</td><td>${m.site}</td><td>${m.qty}</td><td>${m.dose}</td><td>${m.freq}</td><td>${durDisplay}</td><td><button class="btn btn-warning btn-xs" onclick="editStagedItem(${i})">âœï¸</button><button class="btn btn-danger btn-xs" onclick="deleteStagedItem(${i})">x</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function deleteStagedItem(idx) { tempMedStage.splice(idx, 1); renderStaging(); }
        
        function editStagedItem(idx) {
            const m = tempMedStage[idx];
            document.getElementById('stgName').value = m.name; 
            document.getElementById('stgSite').value = m.site;
            document.getElementById('stgQty').value = m.qty; 
            document.getElementById('stgDose').value = m.dose;
            document.getElementById('stgFreq').value = m.freq; 
            document.getElementById('stgDurNum').value = m.durNum;
            document.getElementById('stgDurUnit').value = m.durUnit;
            deleteStagedItem(idx);
        }

        function saveMedicineGroup() {
            const title = document.getElementById('mGroupTitle').value;
            if (!title || tempMedStage.length === 0) return alert("Missing Title/Meds");
            const group = { title: title, meds: [...tempMedStage] };
            store.medGroups.push(group);
            if (typeof google !== 'undefined' && google.script) google.script.run.saveMedTemplateToSheet(group);
            tempMedStage = []; document.getElementById('mGroupTitle').value = '';
            renderStaging(); renderMasters(); populateEntryDropdowns();
        }

        function loadMedTemplate() {
            const idx = document.getElementById('medTemplateSelect').value;
            if (idx === "") return;
            const group = store.medGroups[idx];
            if (group && group.meds) group.meds.forEach(m => addMedRow(m.name, m.site, m.qty, m.dose, m.freq, m.durNum, m.durUnit));
        }

        function addEmptyMedRow() { addMedRow("", "", "", "1", "", "", "Days"); }

        function addMedRow(name, site, qty, dose, freq, durNum, durUnit) {
            const div = document.createElement('div');
            div.className = 'med-row';
            const units = ["Days", "Weeks", "Months", "Years", "Life Time", "To be continued"];
            let unitOptions = "";
            units.forEach(u => { unitOptions += `<option value="${u}" ${u === durUnit ? 'selected' : ''}>${u}</option>`; });
            div.innerHTML = `<input type="text" class="m-name" value="${name}" placeholder="Name" style="flex:3"><select class="m-organ" style="width:85px"><option value="">Site</option><option value="Right Eye" ${site === 'Right Eye' ? 'selected' : ''}>RE</option><option value="Left Eye" ${site === 'Left Eye' ? 'selected' : ''}>LE</option><option value="Both Eyes" ${site === 'Both Eyes' ? 'selected' : ''}>BE</option></select><input type="text" class="m-qty" value="${qty || ''}" placeholder="Qty"><input type="text" class="m-dose" value="${dose}" placeholder="Dose"><input type="text" class="m-freq" value="${freq}" placeholder="Freq" style="flex:2"><div style="flex:3; display:flex; gap:2px;"><input type="number" class="m-dur-num" value="${durNum || ''}" placeholder="#"><select class="m-dur-unit" style="flex:1;">${unitOptions}</select></div><button class="btn btn-danger btn-xs" onclick="this.parentElement.remove()" style="width:40px;height: 38px;">x</button>`;
            document.getElementById('medicineRowsContainer').appendChild(div);
        }

        function clearMedicinesOnly() {
            showConfirm("Clear all medicines from the list?", function(res){ if(res) document.getElementById('medicineRowsContainer').innerHTML = ''; });
        }

        function resetFormWithConfirm() { 
            showConfirm("Clear Form completely?", function(res){ if(res) { resetForm(); window.scrollTo(0, 0); } });
        }

        function renderActionButtons(isEditMode) {
            const container = document.getElementById('actionButtonsContainer');
            if (isEditMode) {
                container.innerHTML = `<button class="btn btn-success" style="flex:1;" onclick="saveAndPrintSummary(false)">UPDATE & PRINT SUMMARY</button><button class="btn btn-info" style="flex:1;" onclick="saveAndPrintSummary(true)">SAVE AS NEW</button><button class="btn btn-warning" style="flex:1;" onclick="resetFormWithConfirm()">CLEAR FORM</button>`;
            } else {
                container.innerHTML = `<button class="btn btn-primary" style="flex:2; padding: 15px;" onclick="saveAndPrintSummary(false)">SAVE & PRINT SUMMARY</button><button class="btn btn-warning" style="flex:1;" onclick="resetFormWithConfirm()">CLEAR FORM</button>`;
            }
        }

        function resetForm() {
            document.getElementById('entryUID').value = ''; 
            renderActionButtons(false);
            document.getElementById('clinicalTemplateSelect').value = '';
            document.getElementById('medTemplateSelect').value = '';
            const fields = ['pName', 'pAge', 'pGender', 'pUHID', 'pPhone', 'pAddress', 'selDoc', 'selReason', 'selSurgery', 'selInv', 'selIOL', 'selAnaesthesia', 'selDiagRight', 'selDiagLeft', 'iolSerial', 'iolPower'];
            fields.forEach(f => { if (document.getElementById(f)) document.getElementById(f).value = ''; });
            const now = new Date();
            const fmtDate = (d) => d.toISOString().split('T')[0];
            const fmtTime = (d) => d.toTimeString().split(' ')[0].substring(0, 5);
            const GAP_MS = 43 * 60000;
            const dischargeTime = now;
            const surgeryTime = new Date(dischargeTime.getTime() - GAP_MS);
            const admissionTime = new Date(surgeryTime.getTime() - GAP_MS);
            document.getElementById('dateDisch').value = fmtDate(dischargeTime);
            document.getElementById('timeDisch').value = fmtTime(dischargeTime);
            document.getElementById('dateSurg').value = fmtDate(surgeryTime);
            document.getElementById('timeSurg').value = fmtTime(surgeryTime);
            document.getElementById('dateAdm').value = fmtDate(admissionTime);
            document.getElementById('timeAdm').value = fmtTime(admissionTime);
            calcFollowUp();
            document.getElementById('medicineRowsContainer').innerHTML = '';
        }

        function calcFollowUp() {
            const disch = document.getElementById('dateDisch').value;
            if (disch) {
                const d = new Date(disch);
                d.setDate(d.getDate() + 1);
                if (d.getDay() === 0) d.setDate(d.getDate() + 1);
                document.getElementById('followUpDate').value = d.toISOString().split('T')[0];
            }
        }

        function openTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active-panel'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active-panel');
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => { if(btn.getAttribute('onclick').includes(id)) btn.classList.add('active'); });
        }

        function toTitleCase(str) {
            if(!str) return "";
            return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }

        function saveAndPrintSummary(forceNew) {
            if (!document.getElementById('pName').value) return alert("Patient Name Required");
            const reqFields = [{id: 'selReason', name: 'Reason of Admission'},{id: 'selSurgery', name: 'Surgery Performed'},{id: 'selInv', name: 'Investigations'},{id: 'selAnaesthesia', name: 'Anaesthesia Given'}];
            for (let f of reqFields) { if(!document.getElementById(f.id).value.trim()) { alert(`${f.name} is mandatory.`); return; } }
            if(!document.getElementById('selDiagRight').value.trim() && !document.getElementById('selDiagLeft').value.trim()) { alert("Please provide Final Diagnosis for at least one eye."); return; }
            const rawName = document.getElementById('pName').value;
            const rawAddress = document.getElementById('pAddress').value;
            const rawUHID = document.getElementById('pUHID').value;
            let currentUID = document.getElementById('entryUID').value;
            if (!currentUID || forceNew) {
                currentUID = generateUUID();
                document.getElementById('entryUID').value = currentUID;
            }
            const patientData = {
                uid: currentUID,
                name: toTitleCase(rawName),
                age: document.getElementById('pAge').value,
                gender: document.getElementById('pGender').value,
                uhid: rawUHID.toUpperCase(),
                phone: document.getElementById('pPhone').value,
                address: toTitleCase(rawAddress),
                doctor: document.getElementById('hDocName').value,
                docDesig: document.getElementById('hDocDesig').value,
                docReg: document.getElementById('hDocReg').value,
                reason: document.getElementById('selReason').value,
                surgery: document.getElementById('selSurgery').value,
                inv: document.getElementById('selInv').value,
                anaesthesia: document.getElementById('selAnaesthesia').value,
                diagRight: document.getElementById('selDiagRight').value,
                diagLeft: document.getElementById('selDiagLeft').value,
                iolName: document.getElementById('selIOL').value,
                iolSerial: document.getElementById('iolSerial').value,
                iolPower: document.getElementById('iolPower').value,
                dateAdm: document.getElementById('dateAdm').value,
                timeAdm: document.getElementById('timeAdm').value,
                dateSurg: document.getElementById('dateSurg').value,
                timeSurg: document.getElementById('timeSurg').value,
                dateDisch: document.getElementById('dateDisch').value,
                timeDisch: document.getElementById('timeDisch').value,
                followUpDate: document.getElementById('followUpDate').value,
                followUpTime: document.getElementById('followUpTime').value,
                medicines: []
            };
            document.querySelectorAll('.med-row').forEach(r => {
                const name = r.querySelector('.m-name').value;
                if (name) {
                    patientData.medicines.push({
                        name: name,
                        site: r.querySelector('.m-organ').value,
                        qty: r.querySelector('.m-qty').value,
                        dose: r.querySelector('.m-dose').value,
                        freq: r.querySelector('.m-freq').value,
                        durNum: r.querySelector('.m-dur-num').value,
                        durUnit: r.querySelector('.m-dur-unit').value
                    });
                }
            });
            const existingIndex = store.discharges.findIndex(d => d.uid === currentUID);
            if (existingIndex >= 0) store.discharges[existingIndex] = patientData;
            else store.discharges.push(patientData);
            renderActionButtons(true);
            if (typeof google !== 'undefined' && google.script) google.script.run.saveDischargeRecord(patientData);
            renderDischargeList();
            fillPrintDom(patientData);
            window.print();
        }

        function fillPrintDom(data) {
            const setT = (id, v) => document.getElementById(id).innerText = v || '';
            const fmt = (dStr, tStr) => {
                if (!dStr) return "";
                const [y, m, d] = dStr.split('-');
                let time = "";
                if (tStr) {
                    let [hr, min] = tStr.split(':');
                    const ampm = hr >= 12 ? 'PM' : 'AM';
                    hr = hr % 12 || 12;
                    time = ` & ${hr}:${min} ${ampm}`;
                }
                return `${d}/${m}/${y}${time}`;
            };
            document.getElementById('pr_qr_container').style.display = store.config.showQR ? 'block' : 'none';
            setT('pr_name', data.name);
            setT('pr_agegen', `${data.age} / ${data.gender}`);
            setT('pr_uhid', data.uhid);
            setT('pr_phone', data.phone);
            setT('pr_address', data.address);
            setT('pr_dname', data.doctor);
            setT('pr_ddesig', data.docDesig);
            setT('pr_sigName', data.doctor);
            setT('pr_sigReg', 'Reg No: ' + data.docReg);
            setT('pr_adm', fmt(data.dateAdm, data.timeAdm));
            setT('pr_surg', fmt(data.dateSurg, data.timeSurg));
            setT('pr_disch', fmt(data.dateDisch, data.timeDisch));
            setT('pr_surgeon', data.doctor);
            setT('pr_reason', data.reason);
            let diagHTML = "";
            if (data.diagRight) diagHTML += `<div>Right Eye ${data.diagRight}</div>`;
            if (data.diagLeft) diagHTML += `<div>Left Eye ${data.diagLeft}</div>`;
            document.getElementById('pr_diagnosis_combined').innerHTML = diagHTML;
            setT('pr_surgery', data.surgery);
            setT('pr_inv', data.inv);
            const custContainer = document.getElementById('pr_custom_section_container');
            custContainer.innerHTML = ''; 
            if (store.customLines && store.customLines.length > 0) {
                store.customLines.forEach(l => {
                    if(l.active) {
                        const div = document.createElement('div');
                        div.className = 'p-row';
                        div.innerHTML = `<span class="ds-label">${l.heading}</span><span class="p-sep">:</span><span class="p-val" style="white-space: pre-line;">${l.text}</span>`;
                        custContainer.appendChild(div);
                    }
                });
            }
            setT('pr_ana', data.anaesthesia);
            if(!data.iolName && !data.iolSerial) {
                document.getElementById('pr_iol_section').style.display = 'none';
            } else {
                document.getElementById('pr_iol_section').style.display = 'block';
                setT('pr_iolname', data.iolName);
                setT('pr_iolserial', data.iolSerial.toUpperCase());
                const rawPower = data.iolPower;
                if(rawPower && !isNaN(parseFloat(rawPower))) setT('pr_iolpower', parseFloat(rawPower).toFixed(2) + " D");
                else setT('pr_iolpower', rawPower); 
            }
            const tb = document.getElementById('pr_medBody');
            tb.innerHTML = '';
            data.medicines.forEach(m => {
                let durStr = m.durUnit;
                if(m.durUnit !== "Life Time" && m.durUnit !== "To be continued") {
                    if(m.durNum) {
                        const label = (parseInt(m.durNum) === 1) ? m.durUnit.slice(0, -1) : m.durUnit;
                        durStr = `${m.durNum}-${label}`;
                    }
                }
                const siteDisplay = m.site ? ` (${m.site})` : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${m.name}${siteDisplay}</td><td>${m.qty}</td><td>${m.dose}</td><td>${m.freq}</td><td>${durStr}</td>`;
                tb.appendChild(tr);
            });
            const fuDate = data.followUpDate;
            if (fuDate) {
                const [y, m, d] = fuDate.split('-');
                setT('pr_followup', `${d}-${m}-${y} (09:00 AM)`);
            }
        }

        function renderDischargeList() {
            const tbody = document.getElementById('dischargeListBody');
            const searchVal = document.getElementById('dischargeSearch').value.toLowerCase();
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            tbody.innerHTML = '';
            let foundCount = 0;
            for (let i = store.discharges.length - 1; i >= 0; i--) {
                const p = store.discharges[i];
                const searchStr = `${p.name} ${p.uhid} ${p.phone} ${p.doctor} ${p.dateDisch}`.toLowerCase();
                if (searchVal && !searchStr.includes(searchVal)) continue;
                if (dateFrom && p.dateDisch < dateFrom) continue;
                if (dateTo && p.dateDisch > dateTo) continue;
                foundCount++;
                const [y, m, d] = p.dateDisch.split('-');
                const dateDisplay = `${d}/${m}/${y}`;
                const uid = p.uid || 'LEGACY';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${dateDisplay}</td><td><b>${p.name}</b></td><td>${p.age} / ${p.gender}</td><td>${p.uhid}</td><td>${p.doctor}</td><td>${p.iolName || '-'}</td><td>${p.iolPower || '-'}</td><td>${p.iolSerial || '-'}</td><td><div style="display:flex;"><button class="btn btn-view btn-xs" onclick="viewDischarge('${uid}', ${i})">View</button><button class="btn btn-warning btn-xs" onclick="editDischarge('${uid}', ${i})">Edit</button><button class="btn btn-danger btn-xs" onclick="deleteDischarge('${uid}', ${i})">ðŸ—‘ï¸</button></div></td>`;
                tbody.appendChild(tr);
            }
            if (foundCount === 0) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No records found matching criteria.</td></tr>';
        }

        function deleteDischarge(uid, index) {
            showConfirm("Are you sure you want to delete this discharge record?", function(res){
                if(res) {
                    if (uid !== 'LEGACY') store.discharges = store.discharges.filter(d => d.uid !== uid);
                    else store.discharges.splice(index, 1);
                    if (typeof google !== 'undefined' && google.script) google.script.run.deleteDischargeRecord(uid);
                    renderDischargeList();
                }
            });
        }

        function exportToCSV() {
            if(store.discharges.length === 0) return alert("No records to export.");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Patient Name,Age,Gender,UHID,Phone,Address,Doctor,IOL Name,IOL Power,Serial No\n";
            store.discharges.forEach(p => {
                const row = [p.dateDisch,`"${p.name}"`,p.age,p.gender,p.uhid,p.phone,`"${p.address.replace(/\n/g, ' ')}"`,`"${p.doctor}"`,`"${p.iolName || ''}"`,p.iolPower || '',p.iolSerial || ''];
                csvContent += row.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "discharge_list.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function viewDischarge(uid, index) {
            let p = (uid !== 'LEGACY') ? store.discharges.find(d => d.uid === uid) : store.discharges[index];
            if(!p) return;
            fillPrintDom(p);
            window.print();
        }

        function editDischarge(uid, index) {
            let p = (uid !== 'LEGACY') ? store.discharges.find(d => d.uid === uid) : store.discharges[index];
            if(!p) return;
            document.getElementById('entryUID').value = p.uid || ''; 
            renderActionButtons(true);
            document.getElementById('pName').value = p.name;
            document.getElementById('pAge').value = p.age;
            document.getElementById('pGender').value = p.gender;
            document.getElementById('pUHID').value = p.uhid;
            document.getElementById('pPhone').value = p.phone;
            document.getElementById('pAddress').value = p.address;
            document.getElementById('hDocName').value = p.doctor;
            document.getElementById('hDocDesig').value = p.docDesig;
            document.getElementById('hDocReg').value = p.docReg;
            document.getElementById('selDoc').value = p.doctor; 
            document.getElementById('selReason').value = p.reason;
            document.getElementById('selSurgery').value = p.surgery;
            document.getElementById('selInv').value = p.inv;
            document.getElementById('selAnaesthesia').value = p.anaesthesia || '';
            document.getElementById('selDiagRight').value = p.diagRight || '';
            document.getElementById('selDiagLeft').value = p.diagLeft || '';
            document.getElementById('selIOL').value = p.iolName;
            document.getElementById('iolSerial').value = p.iolSerial;
            document.getElementById('iolPower').value = p.iolPower;
            document.getElementById('dateAdm').value = p.dateAdm;
            document.getElementById('timeAdm').value = p.timeAdm;
            document.getElementById('dateSurg').value = p.dateSurg;
            document.getElementById('timeSurg').value = p.timeSurg;
            document.getElementById('dateDisch').value = p.dateDisch;
            document.getElementById('timeDisch').value = p.timeDisch;
            document.getElementById('followUpDate').value = p.followUpDate;
            document.getElementById('followUpTime').value = p.followUpTime;
            document.getElementById('medicineRowsContainer').innerHTML = '';
            if(p.medicines) p.medicines.forEach(m => { addMedRow(m.name, m.site, m.qty, m.dose, m.freq, m.durNum, m.durUnit); });
            openTab('entryPanel');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>